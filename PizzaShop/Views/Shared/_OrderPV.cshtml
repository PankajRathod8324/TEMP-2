@using X.PagedList.Mvc.Core
@model X.PagedList.IPagedList< Entities.ViewModel.OrderVM>


<body>
    <div class="table-responsive bg-white" style="max-height: 400px; overflow-y: auto;">
        <table class="table  align-middle text-center">
            <thead class="bg-light">
                <tr>
                    <th class="text-secondary fs-6">
                        <a asp-action="Userpage" asp-route-sortBy="Name"
                            asp-route-isAsc="@(ViewBag.SortBy == "Name" ? !ViewBag.IsAsc : true)"
                            class="sorting-link text-secondary">
                            #Order
                            <span class="icon-box">
                                <i
                                    class="fa-solid fa-arrow-up @(ViewBag.SortBy == "Name" && ViewBag.IsAsc ? "active-icon" : "inactive-icon")"></i>
                                <i
                                    class="fa-solid fa-arrow-down @(ViewBag.SortBy == "Name" && !ViewBag.IsAsc ? "active-icon" : "inactive-icon")"></i>
                            </span>
                        </a>
                    </th>

                    <th class="text-secondary fs-6">
                        <a asp-action="Userpage" asp-route-sortBy="Name"
                            asp-route-isAsc="@(ViewBag.SortBy == "Name" ? !ViewBag.IsAsc : true)"
                            class="sorting-link text-secondary">
                            Date
                            <span class="icon-box">
                                <i
                                    class="fa-solid fa-arrow-up @(ViewBag.SortBy == "Name" && ViewBag.IsAsc ? "active-icon" : "inactive-icon")"></i>
                                <i
                                    class="fa-solid fa-arrow-down @(ViewBag.SortBy == "Name" && !ViewBag.IsAsc ? "active-icon" : "inactive-icon")"></i>
                            </span>
                        </a>
                    </th>

                    <th class="text-secondary fs-6">
                        <a asp-action="Userpage" asp-route-sortBy="Name"
                            asp-route-isAsc="@(ViewBag.SortBy == "Name" ? !ViewBag.IsAsc : true)"
                            class="sorting-link text-secondary">
                            Customer
                            <span class="icon-box">
                                <i
                                    class="fa-solid fa-arrow-up @(ViewBag.SortBy == "Name" && ViewBag.IsAsc ? "active-icon" : "inactive-icon")"></i>
                                <i
                                    class="fa-solid fa-arrow-down @(ViewBag.SortBy == "Name" && !ViewBag.IsAsc ? "active-icon" : "inactive-icon")"></i>
                            </span>
                        </a>
                    </th>

                    <th class="text-secondary fs-6">Status</th>
                    <th class="text-secondary fs-6">Payment Mode</th>
                    <th class="text-secondary fs-6">Rating</th>
                    <th>
                        <a asp-action="Userpage" asp-route-sortBy="Name"
                            asp-route-isAsc="@(ViewBag.SortBy == "Name" ? !ViewBag.IsAsc : true)"
                            class="sorting-link text-secondary">
                            Total Amount
                            <span class="icon-box">
                                <i
                                    class="fa-solid fa-arrow-up @(ViewBag.SortBy == "Name" && ViewBag.IsAsc ? "active-icon" : "inactive-icon")"></i>
                                <i
                                    class="fa-solid fa-arrow-down @(ViewBag.SortBy == "Name" && !ViewBag.IsAsc ? "active-icon" : "inactive-icon")"></i>
                            </span>
                        </a>
                    </th>

                    <th class="text-secondary fs-6">Action</th>
                </tr>
            </thead>
            <tbody>
                @if (Model.Any(order => order.OrderId != null))
                {
                    @foreach (var order in Model)
                    {
                        if (order.OrderId != null)
                        {
                            <tr class="tblclass" data-id="@order.OrderId">
                                <td>
                                    <p class=" text-secondary  mb-0 ">#@order.OrderId</p>
                                </td>
                                <td>
                                    <p class="text-secondary  mb-0">@order.Date</p>
                                </td>
                                <td>
                                    <p class=" text-secondary  mb-0">@order.CustomerName</p>
                                </td>
                                <td>
                                    <p class=" text-secondary  mb-0">@order.OrderStatus</p>
                                </td>
                                <td>
                                    <p class=" text-secondary  mb-0">@order.PaymentMode</p>
                                </td>
                                <td>
                                    @* <p class="fw-bold text-secondary  mb-0">@order.ReviewRating</p> *@
                                    @for (int i = 0; i < 5; i++)
                                    {
                                        if (i < order.ReviewRating)
                                        {
                                            <i class="fa fa-star text-warning"></i>

                                        }
                                        else
                                        {
                                            <i class="fa-regular fa-star" style="color: #FFD43B;"></i>
                                        }
                                    }
                                </td>
                                <td>
                                    <p class=" text-secondary  mb-0">@order.TotalAmount</p>
                                </td>
                                <td>
                                    <button class="btn btn-sm text-secondary pdfBtn" data-id="@order.OrderId">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor"
                                            class="bi bi-filetype-pdf" viewBox="0 0 16 16">
                                            <path fill-rule="evenodd"
                                                d="M14 4.5V14a2 2 0 0 1-2 2h-1v-1h1a1 1 0 0 0 1-1V4.5h-2A1.5 1.5 0 0 1 9.5 3V1H4a1 1 0 0 0-1 1v9H2V2a2 2 0 0 1 2-2h5.5zM1.6 11.85H0v3.999h.791v-1.342h.803q.43 0 .732-.173.305-.175.463-.474a1.4 1.4 0 0 0 .161-.677q0-.375-.158-.677a1.2 1.2 0 0 0-.46-.477q-.3-.18-.732-.179m.545 1.333a.8.8 0 0 1-.085.38.57.57 0 0 1-.238.241.8.8 0 0 1-.375.082H.788V12.48h.66q.327 0 .512.181.185.183.185.522m1.217-1.333v3.999h1.46q.602 0 .998-.237a1.45 1.45 0 0 0 .595-.689q.196-.45.196-1.084 0-.63-.196-1.075a1.43 1.43 0 0 0-.589-.68q-.396-.234-1.005-.234zm.791.645h.563q.371 0 .609.152a.9.9 0 0 1 .354.454q.118.302.118.753a2.3 2.3 0 0 1-.068.592 1.1 1.1 0 0 1-.196.422.8.8 0 0 1-.334.252 1.3 1.3 0 0 1-.483.082h-.563zm3.743 1.763v1.591h-.79V11.85h2.548v.653H7.896v1.117h1.606v.638z" />
                                        </svg>
                                    </button>
                                    <button class="btn btn-sm text-secondary selectedorder" data-id="@order.OrderId">
                                        <i class="fa-regular fa-eye"></i>
                                    </button>
                                </td>


                            </tr>
                        }
                    }
                }
                else
                {
                    <tr>
                        <td colspan="6" class="text-center text-muted">
                            <p class="mb-0">No Tables found!</p>
                        </td>
                    </tr>
                }

            </tbody>

        </table>


        <div class="d-flex justify-content-end align-items-center my-3 gap-2">
            <form id="paginationForm" method="get" class="d-flex align-items-center me-3">
                <span class="me-2">Items per page:</span>
                <select id="pageSizeDropdown" class="form-select form-select-sm w-auto me-3">
                    <option value="5" selected="@(ViewBag.PageSize == 5)">5</option>
                    <option value="10" selected="@(ViewBag.PageSize == 10)">10</option>
                    <option value="15" selected="@(ViewBag.PageSize == 15)">15</option>
                </select>


                <span id="pagination-summary" class="text-muted">
                    Showing @(Model.PageSize * (Model.PageNumber - 1) + 1) -
                    @((Model.PageSize * Model.PageNumber) > Model.TotalItemCount ? Model.TotalItemCount :
                                        (Model.PageSize *
                                        Model.PageNumber))
                    of @Model.TotalItemCount results
                </span>
            </form>

            <div id="paginationContainer">
                @if (Model.HasPreviousPage)
                {
                    <button class="btn btn-outline-dark pagination-btn" data-page="@(Model.PageNumber - 1)">
                        <i class="fa-solid fa-chevron-left"></i>
                    </button>
                }

                <span class="mx-2">Page @Model.PageNumber of @Model.PageCount</span>

                @if (Model.HasNextPage)
                {
                    <button class="btn btn-outline-dark pagination-btn" data-page="@(Model.PageNumber + 1)">
                        <i class="fa-solid fa-chevron-right"></i>
                    </button>
                }
            </div>

        </div>
    </div>
    <script>
        $(document).ready(function () {
            // Handle Page Size Change
            $("#pageSizeDropdown").change(function () {
                console.log("Dropdown changed");
                loadTaxes(1); // Reset to page 1 when changing page size
            });
            $(".saveBtn").click(function () {
                console.log("Search Button Clicked");
                loadTaxes(1); // Reset to page 1 on search
            });
            $(".cleareverything").on("click", function () {
                console.log("Clcikerf");
                $("#startDate").val("");
                $("#endDate").val("");
                @* loadTaxes(1); *@
            });
            $(".selectedorder").click(function () {
                var orderId = $(this).data("id");
                console.log(orderId);
                window.location.href = "/Order/OrderDetails?orderId=" + orderId;
            });
            $(".pdfBtn").click(function () {
                var orderId = $(this).data("id");
                console.log(orderId);
                $.ajax({
                    url: `/Order/GeneratePDF?orderId=${orderId}`,
                    type: 'GET',
                    xhrFields: { responseType: 'blob' }, // Ensures binary data handling
                    success: function (data, status, xhr) {
                        var blob = new Blob([data], { type: 'application/pdf' });
                        var link = document.createElement('a');
                        link.href = window.URL.createObjectURL(blob);
                        link.download = `Order_${orderId}.pdf`;
                        document.body.appendChild(link);
                        link.click();
                        document.body.removeChild(link);
                    },
                    error: function () {
                        alert("Failed to download PDF.");
                    }
                });

            })


        });

        function loadTaxes(page = 1) {
            var search = $("#searchInput").val();
            var orderStatus = $("#orderStatus").val();
            var filterdate = $("#datefilter").val();
            var startDate = $("#startDate").val();
            var endDate = $("#endDate").val();
            console.log(startDate);
            console.log(endDate);
            @* var sortOrder = $("#sortOrder").val(); *@
            var pageSize = $("#pageSizeDropdown").val();
            console.log(search);
            @* console.log("Page:", page, "PageSize:", pageSize); *@

                $.ajax({
                    url: '/Order/Order',  // Ensure this route matches your controller
                    type: 'GET',
                    data: {
                        search: search,
                        page: page,
                        pageSize: pageSize,
                        orderStatus: orderStatus,
                        filterdate: filterdate,
                        startDate: startDate,
                        endDate: endDate
                    },
                    success: function (data) {
                        $("#orderTable").html(data);  // Update the menu items container

                    },
                    error: function (xhr, status, error) {
                        console.error('Error fetching items:', error);
                    }
                });
        }

    </script>

</body>